# src/security/malware_detector.py
import hashlib
import numpy as np
from sentence_transformers import SentenceTransformer
from typing import List, Dict
import json

class MalwareDetector:
    def __init__(self, qdrant_manager, model_name="all-MiniLM-L6-v2"):
        self.qdrant = qdrant_manager
        self.encoder = SentenceTransformer(model_name)
        
    def create_file_signature(self, file_content: bytes) -> Dict:
        """Create file signature"""
        # Create file hash
        file_hash = hashlib.sha256(file_content).hexdigest()
        
        # Convert file bytes to text (hex representation)
        hex_content = file_content.hex()[:1000]  # Use only the first 1000 characters
        
        # Embed string to vector
        embedding = self.encoder.encode(hex_content).tolist()
        
        return {
            "hash": file_hash,
            "content": hex_content,
            "embedding": embedding,
            "threat_level": "unknown",
            "category": "file_signature"
        }
    
    def analyze_suspicious_file(self, file_content: bytes, threshold: float = 0.8):
        """Analyze suspicious file"""
        # Create file signature
        signature = self.create_file_signature(file_content)
        
        # Search for similar malware
        results = self.qdrant.security_search(
            query_vector=signature["embedding"],
            collection_type="malware_signatures",
            limit=10
        )
        
        analysis_result = {
            "file_hash": signature["hash"],
            "is_suspicious": False,
            "similarity_score": 0.0,
            "similar_threats": [],
            "recommendation": "File seems to be safe"
        }
        
        if results:
            max_score = max([result.score for result in results])
            analysis_result["similarity_score"] = max_score
            
            if max_score >= threshold:
                analysis_result["is_suspicious"] = True
                analysis_result["recommendation"] = f"Danger! {max_score:.2%} similar to existing malware"
                
                # Collect information on similar threats
                for result in results[:3]:
                    threat_info = {
                        "similarity": result.score,
                        "threat_level": result.payload.get("threat_level", "unknown"),
                        "source": result.payload.get("source", "unknown")
                    }
                    analysis_result["similar_threats"].append(threat_info)
        
        return analysis_result
    
    def load_malware_database(self, file_path: str):
        """Load malware database"""
        with open(file_path, 'r', encoding='utf-8') as f:
            malware_data = json.load(f)
        
        # Vectorize each malware information
        processed_data = []
        for malware in malware_data:
            # Convert malware information to text
            text_content = f"{malware.get('name', '')} {malware.get('description', '')} {malware.get('hash', '')}"
            embedding = self.encoder.encode(text_content).tolist()
            
            processed_data.append({
                "content": text_content,
                "embedding": embedding,
                "threat_level": malware.get("threat_level", "high"),
                "source": malware.get("source", "malware_db"),
                "category": "malware"
            })
        
        # Save to Qdrant
        self.qdrant.add_security_data("malware_signatures", processed_data)
        print(f"{len(processed_data)} malware signatures loaded")
