import requests
import csv
import json
import os

url = "https://bazaar.abuse.ch/export/csv/recent/"
output_file = "data/sample_malware_hashes.json"

response = requests.get(url)

if response.status_code == 200:
    decoded = response.content.decode("utf-8")
    lines = decoded.splitlines()
    malware_list = []

    # CSV에 주석 줄(#) 무시
    reader = csv.DictReader(line for line in lines if not line.startswith("#"))

    for row in reader:
        malware_info = {
            "malware_name": row.get("signature", "unknown"),
            "sha256_hash": row.get("sha256_hash"),
            "tags": row.get("tags", "").split("|") if row.get("tags") else [],
            "file_type": row.get("file_type", ""),
            "first_seen": row.get("first_seen", "")
        }
        malware_list.append(malware_info)

        if len(malware_list) >= 10:
            break

    os.makedirs("data", exist_ok=True)
    with open(output_file, "w") as f:
        json.dump(malware_list, f, indent=2)

    print(f"[✓] 저장 완료: {output_file}")

else:
    print(f"[X] 다운로드 실패: {response.status_code}")
